<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>D3D11DRV: TexConversion Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>TexConversion Class Reference</h1><!-- doxytag: class="TexConversion" -->
<p><a href="class_tex_conversion-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_tex_conversion_1_1_texture_format.html">TextureFormat</a></td></tr>
<tr><td colspan="2"><h2>Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tex_conversion.html#a9867a16661ea9b176d5e6054a5debf30">convertAndCache</a> (FTextureInfo &amp;Info, DWORD PolyFlags)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tex_conversion.html#a6aaaa1050c9cb0310a29f8867e8eeab7">update</a> (FTextureInfo &amp;Info, DWORD PolyFlags)</td></tr>
<tr><td colspan="2"><h2>Static Private Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tex_conversion.html#a35c6f5c84859b5a9c29d1660ad405edd">convertMip</a> (FTextureInfo &amp;Info, <a class="el" href="struct_tex_conversion_1_1_texture_format.html">TextureFormat</a> &amp;format, DWORD PolyFlags, int mipLevel, D3D11_SUBRESOURCE_DATA &amp;data)</td></tr>
<tr><td colspan="2"><div class="groupHeader">Format conversion functions</div></td></tr>
<tr><td colspan="2"><div class="groupText"><p><a class="anchor" id="amgrp454bb6364d76124709990b67f155acf0"></a> </p>
<br/><br/></div></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tex_conversion.html#a18203ab72dbe1fd3770ddc9e4e30995a">fromPaletted</a> (FTextureInfo &amp;Info, DWORD PolyFlags, void *target, int mipLevel)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tex_conversion.html#a0b76dde2373ebd5b34796c644cfc0efb">fromBGRA7</a> (FTextureInfo &amp;Info, DWORD PolyFlags, void *target, int mipLevel)</td></tr>
<tr><td colspan="2"><h2>Static Private Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="struct_tex_conversion_1_1_texture_format.html">TexConversion::TextureFormat</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tex_conversion.html#a3b80e0e5788ec517b52ba69fcd291892">formats</a> []</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Functions to convert from Unreal format textures to standard R8G8B8A8 Direct3D 11 format inital data. Uses both Unreal and Direct3D datatypes, but no access to <a class="el" href="class_d3_d.html">D3D</a> objects like the device etc.</p>
<p>The game has two types of textures: static ones and dynamic. Dynamic texures are parametric ones such as water, etc. After trying multiple methods, it was determined best to create static textures as USAGE_IMMUTABLE, and dynamic ones as USAGE_DEFAULT (i.e. not USAGE_DYNAMIC). USAGE_DEFAULT textures cannot be mapped, but they are updated using a copy operation. A nice thing about this is that it allows the texture handling to be streamlined; it used to have seperate paths for map()-able and immutable textures. However copy-able and immutable textures can be handled about the same way as they both are created from initial data, instead of being filled after their creation.</p>
<p>Some texture types can be used by <a class="el" href="class_d3_d.html">D3D</a> without conversion; depending on the type (see formats array below) direct assignments can take place.</p>
<p>New textures are created by having the <a class="el" href="class_d3_d.html">D3D</a> class create a texture out of their converted/assigned mips stored as D3D_SUBRESOURCE_DATA; the texture conversion function sets the TEXTURE_2D_DESC parameters for this depending on the texture size, if it is dynamic, etc. Existing textures are updated by passing a new mip to the <a class="el" href="class_d3_d.html">D3D</a> class; only the 0th mip is updated, which should be fine (afaik there's no dynamic textures with &gt;1 mips).</p>
<p>Texture conversion functions write to a void pointer so they can work unmodified regardless of the underlying memory.</p>
<p>Additional notes:</p>
<ul>
<li>Textures can be updated while a frame is being drawn (i.e. between lock() and unlock()). This means that a texture can even need to be be updated between two successive drawXXXX() calls.</li>
<li>Textures haven't always the correct 'masked' flag upon initial caching. as such, they must sometimes be replaced if the game later tries to load it with the flag. As this cannot be detected in advance, they're created as immutable. Updating is done by deleting and recreating.</li>
<li>For example dynamic lights have neither bParametric nor bRealtime set. Fortunately, these seem to have bRealtimechanged set initially.</li>
<li>BRGA7 textures have garbage data outside their UClamp and reading outside the VClamp can lead to access violations. To be able to still direct assign them, all textures are made only as large as the UClamp*VClamp and the texture coordinates are scaled to reflect this. Furthermore, the D3D_SUBRESOURCE_DATA's stride parameter is set so the data outside the UClamp is skipped. </li>
</ul>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a9867a16661ea9b176d5e6054a5debf30"></a><!-- doxytag: member="TexConversion::convertAndCache" ref="a9867a16661ea9b176d5e6054a5debf30" args="(FTextureInfo &amp;Info, DWORD PolyFlags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TexConversion::convertAndCache </td>
          <td>(</td>
          <td class="paramtype">FTextureInfo &amp;&nbsp;</td>
          <td class="paramname"> <em>Info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DWORD&nbsp;</td>
          <td class="paramname"> <em>PolyFlags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Fill texture info structure and execute proper conversion of pixel data.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>Info</em>&nbsp;</td><td>Unreal texture information, includes cache id, size information, texture data. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>PolyFlags</em>&nbsp;</td><td>Polyflags, see <a class="el" href="polyflags_8h.html">polyflags.h</a>. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a35c6f5c84859b5a9c29d1660ad405edd"></a><!-- doxytag: member="TexConversion::convertMip" ref="a35c6f5c84859b5a9c29d1660ad405edd" args="(FTextureInfo &amp;Info, TextureFormat &amp;format, DWORD PolyFlags, int mipLevel, D3D11_SUBRESOURCE_DATA &amp;data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TexConversion::convertMip </td>
          <td>(</td>
          <td class="paramtype">FTextureInfo &amp;&nbsp;</td>
          <td class="paramname"> <em>Info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_tex_conversion_1_1_texture_format.html">TextureFormat</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>format</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DWORD&nbsp;</td>
          <td class="paramname"> <em>PolyFlags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mipLevel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">D3D11_SUBRESOURCE_DATA &amp;&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Fills a SUBRESOURCE_DATA structure with converted texture data for a mipmap; if possible, assigns instead of converts. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>Info</em>&nbsp;</td><td>Unreal texture info. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>format</em>&nbsp;</td><td>Conversion parameters for the texture. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>PolyFlags</em>&nbsp;</td><td>Polyflags. See <a class="el" href="polyflags_8h.html">polyflags.h</a>. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>mipLevel</em>&nbsp;</td><td>Which mip to convert. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>SUBRESOURCE_DATA structure which will be filled.</td></tr>
  </table>
  </dd>
</dl>
<dl class="note"><dt><b>Note:</b></dt><dd>Caller must free data.pSysMem for non-directAssign textures. </dd></dl>

</div>
</div>
<a class="anchor" id="a0b76dde2373ebd5b34796c644cfc0efb"></a><!-- doxytag: member="TexConversion::fromBGRA7" ref="a0b76dde2373ebd5b34796c644cfc0efb" args="(FTextureInfo &amp;Info, DWORD PolyFlags, void *target, int mipLevel)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TexConversion::fromBGRA7 </td>
          <td>(</td>
          <td class="paramtype">FTextureInfo &amp;&nbsp;</td>
          <td class="paramname"> <em>Info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DWORD&nbsp;</td>
          <td class="paramname"> <em>PolyFlags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mipLevel</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>BGRA7 to RGBA8. Used for lightmaps and fog. Straightforward, just multiply by 2. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>IMPORTANT these textures do not have valid data outside of their U/VClamp; there's garbage outside UClamp and reading it outside VClamp sometimes results in access violations. Unfortunately this means a direct assignment is not possible as we need to manually repeat the rows/columns outside of the clamping range. </dd>
<dd>
This format is only used for fog and lightmap; it is also the only format used for those. As such, we can at least do the swizzling and scaling in-shader and use memcpy() here. </dd></dl>
<dl class="deprecated"><dt><b><a class="el" href="deprecated.html#_deprecated000001">Deprecated:</a></b></dt><dd>Direct assignment instead, see text at top of file. </dd></dl>

</div>
</div>
<a class="anchor" id="a18203ab72dbe1fd3770ddc9e4e30995a"></a><!-- doxytag: member="TexConversion::fromPaletted" ref="a18203ab72dbe1fd3770ddc9e4e30995a" args="(FTextureInfo &amp;Info, DWORD PolyFlags, void *target, int mipLevel)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TexConversion::fromPaletted </td>
          <td>(</td>
          <td class="paramtype">FTextureInfo &amp;&nbsp;</td>
          <td class="paramname"> <em>Info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DWORD&nbsp;</td>
          <td class="paramname"> <em>PolyFlags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>target</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mipLevel</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Convert from palleted 8bpp to r8g8b8a8. </p>

</div>
</div>
<a class="anchor" id="a6aaaa1050c9cb0310a29f8867e8eeab7"></a><!-- doxytag: member="TexConversion::update" ref="a6aaaa1050c9cb0310a29f8867e8eeab7" args="(FTextureInfo &amp;Info, DWORD PolyFlags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TexConversion::update </td>
          <td>(</td>
          <td class="paramtype">FTextureInfo &amp;&nbsp;</td>
          <td class="paramname"> <em>Info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DWORD&nbsp;</td>
          <td class="paramname"> <em>PolyFlags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Update a dynamic texture by converting its 0th mip and letting <a class="el" href="class_d3_d.html">D3D</a> update it. </p>

</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="a3b80e0e5788ec517b52ba69fcd291892"></a><!-- doxytag: member="TexConversion::formats" ref="a3b80e0e5788ec517b52ba69fcd291892" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="struct_tex_conversion_1_1_texture_format.html">TexConversion::TextureFormat</a> <a class="el" href="class_tex_conversion.html#a3b80e0e5788ec517b52ba69fcd291892">TexConversion::formats</a><code> [static, private]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> 
{
        {<span class="keyword">true</span>,0,<span class="keyword">false</span>,DXGI_FORMAT_R8G8B8A8_UNORM,&amp;<a class="code" href="class_tex_conversion.html#a18203ab72dbe1fd3770ddc9e4e30995a">TexConversion::fromPaletted</a>},         
        {<span class="keyword">true</span>,0,<span class="keyword">true</span>,DXGI_FORMAT_R8G8B8A8_UNORM,NULL},                                                          
        {<span class="keyword">false</span>,0,<span class="keyword">true</span>,DXGI_FORMAT_R8G8B8A8_UNORM,NULL},                                                         
        {<span class="keyword">true</span>,4,<span class="keyword">true</span>,DXGI_FORMAT_BC1_UNORM,NULL},                                                                       
        {<span class="keyword">false</span>,0,<span class="keyword">true</span>,DXGI_FORMAT_UNKNOWN,NULL},                                                                        
        {<span class="keyword">true</span>,0,<span class="keyword">true</span>,DXGI_FORMAT_R8G8B8A8_UNORM,NULL},                                                          
}
</pre></div><p>Mappings from Unreal to our texture info </p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>D:/d3d11drv/d3d11drv/<a class="el" href="texconversion_8h_source.html">texconversion.h</a></li>
<li>D:/d3d11drv/d3d11drv/texconversion.cpp</li>
</ul>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Sat Oct 3 23:35:35 2009 for D3D11DRV by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
